{% extends "base.html" %}

{% block title %}Editar {{ componente['Nombre'] }}{% endblock %}
{% block content %}

<div class="page-wrapper">
    <!-- Header -->
    <div class="dashboard-header hidden-item p-4 shadow rounded">
        <div class="header-topbar">
            <div class="header-title">
                <h2 class="section-title"><i class="bi bi-pencil-fill"></i> Editar {{ componente['Nombre'] }}</h2>
                <p class="section-subtitle d-none d-md-block opacity-75">Modifica la información del componente seleccionado</p>
            </div>
            <div class="header-controls">
                <a href="{{ url_for('componentes.lista_componentes') }}" 
                    class="btn btn-outline-primary btn-sm ms-auto">
                    <i class="bi bi-arrow-left"></i> 
                    <span class="d-none d-md-block d-md-inline">Volver</span>
                </a>
                {% if componente %}
                <a href="{{ url_for('componentes.vista_componente', id=componente.ID) }}" 
                    class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-eye"></i> 
                    <span class="d-none d-md-block d-md-inline">Ver</span></a>
                {% endif %}
                <div class="calendar-badge fs-6 d-none d-lg-block">
                    <i class="bi bi-calendar3"></i> <span id="current-date"></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Formulario -->
    <div class="page-section mx-auto mb-3" style="max-width: 700px;">
        <div class="mt-0 card-section mb-0" style="box-shadow: none; max-width: 650px;">
            <form method="POST" enctype="multipart/form-data" id="editComponentForm" 
                class="mt-0 form-edit row mb-0 g-3">
                <!-- Código -->
                <div class="col-12 col-md-6">
                    <label for="codigo" class="form-label">
                        <i class="bi bi-hash"></i> Código del Componente
                    </label>
                    <input type="text" class="form-control" name="codigo" id="codigo"
                        value="{{ componente.ID_Componente if componente and componente.ID_Componente is not none else '' }}"
                        placeholder="Ej: C001, FILT-001">
                </div>
                <!-- Nombre -->
                <div class="col-12 col-md-6">
                    <label for="nombre" class="form-label required">
                        <i class="bi bi-tag"></i> Nombre del Componente
                    </label>
                    <input type="text" class="form-control" name="nombre" id="nombre"
                        value="{{ componente.Nombre if componente and componente.Nombre is not none else '' }}" required placeholder="Ej: Filtro de aceite">
                </div>
                <!-- Tipo -->
                <div class="col-12 col-md-6">
                    <label for="tipo" class="form-label">
                        <i class="bi bi-collection"></i> Tipo
                    </label>
                    <select class="form-select" id="tipo" name="tipo">
                        {% for tipo in tipos %}
                            <option value="{{ tipo }}" {{ 'selected' if tipo_actual == tipo else '' }}>{{ tipo }}</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Marca -->
                <div class="col-12 col-md-6">
                    <label for="marca" class="form-label">
                        <i class="bi bi-award"></i> Marca
                    </label>
                    <input type="text" class="form-control" name="marca" id="marca"
                        value="{{ componente.Marca if componente and componente.Marca is not none else '' }}" placeholder="Ej: Bosch, Mann">
                </div>
                <!-- Modelo -->
                <div class="col-12 col-md-6">
                    <label for="modelo" class="form-label">
                        <i class="bi bi-gear"></i> Modelo
                    </label>
                    <input type="text" class="form-control" name="modelo" id="modelo"
                        value="{{ componente.Modelo if componente and componente.Modelo is not none else '' }}" placeholder="Ej: W712/75, HF6177">
                </div>
                <!-- Precio -->
                <div class="col-12 col-md-6">
                    <label for="precio" class="form-label">
                        <i class="bi bi-currency-dollar"></i> Precio Unitario
                    </label>
                    <div class="custom-input-group">
                        <span class="custom-input-symbol">$</span>
                        <input type="number" name="precio" id="precio"
                            class="custom-input-field"
                            placeholder="0.00" step="0.01" min="0"
                            value="{{ componente.Precio if componente and componente.Precio is not none else '' }}">
                    </div>
                </div>
                <!-- Descripción -->
                <div class="col-12">
                    <label for="descripcion" class="form-label">
                        <i class="bi bi-card-text"></i> Descripción
                    </label>
                    <textarea class="form-control" name="descripcion" id="descripcion"
                        rows="4" placeholder="Detalles técnicos del componente...">{{ componente.Descripcion if componente and componente.Descripcion is not none else '' }}</textarea>
                </div>
                <!-- Imagen -->
                <div class="col-12 custom-file-upload">
                    <label for="foto" class="upload-label">
                        <i class="bi bi-image"></i> Subir imagen
                    </label>

                    <input type="file" id="foto" name="foto" accept="image/*" style="display: none;">
                    
                    <!-- Vista previa del nombre del archivo -->
                    <div id="file-name" class="file-name-preview">
                        {% if componente and componente.Foto %}
                            Imagen actual: {{ componente.Foto }}
                        {% else %}
                            No se ha seleccionado ningún archivo.
                        {% endif %}
                    </div>
                    <!-- Vista previa de imagen seleccionada -->
                    <div id="image-preview" class="mt-3" style="display: flex; justify-content: center;">
                        {% if componente and componente.Foto %}
                            <img src="{{ url_for('static', filename='fotos/componentes/' ~ componente.Foto) }}" 
                                alt="Imagen actual" 
                                class="img-thumbnail" 
                                style="max-width: 200px;">
                        {% endif %}
                    </div>
                </div>
                <!-- Botones de acción -->
                <div class="d-flex gap-3 mt-2 pt-2 custom-border justify-content-center">
                    <button type="submit" class="btn btn-agri-primary w-100" style="border: transparent;">
                        <i class="bi bi-check-lg"></i> Guardar
                    </button>
                </div>
                <div class="d-flex gap-3 mt-2">
                    <a href="{{ url_for('componentes.lista_componentes') }}" class="btn btn-outline-secondary w-50">
                        <i class="bi bi-x-lg"></i> Cancelar
                    </a>    
                    {% if componente %}
                    <button type="button" class="btn btn-outline-danger w-50" onclick="confirmDelete()">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                    {% endif %}
                </div>
            </form>
            <form id="deleteForm" method="POST" action="{{ url_for('componentes.eliminar_componente', id=componente.ID) }}"></form>
        </div>
    </section>

    <!-- Carta con cartas embebidas -->
    <div class="card detail-card p-4 mx-auto" 
        style="max-width: 700px; border: none; box-shadow: none;">
        <h4 class="card-title mb-0 d-flex align-items-center gap-2 justify-content-center">
            <i class="bi bi-box-seam"></i> Detalles del componente
        </h4>

        <div class="row g-4 mt-3">
            <!-- Vista Previa -->
            <div class="col-12 col-md-6 mx-auto" style="max-width: 100%;">
                <div class="card h-100 shadow-sm border-secondary">
                    <div class="card-body text-center">
                        <h5 class="card-title mb-3 d-flex align-items-center justify-content-center gap-2">
                            <i class="bi bi-image"></i> Vista Previa
                        </h5>
                        {% if componente and componente.Foto %}
                            <img src="{{ url_for('static', filename='fotos/componentes/' ~ componente.Foto) }}"
                                alt="Vista previa"
                                class="img-fluid rounded shadow mx-auto d-block"
                                style="max-height: 220px; object-fit: contain;">
                        {% else %}
                            <div class="image-placeholder mx-auto" 
                                style="width: 180px; height: 180px;">
                                <i class="bi bi-image fs-1"></i>
                                <p class="mb-0 mt-2">Sin imagen</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Información rápida -->
            <div class="col-12 col-md-6 mx-auto" style="max-width: 100%;">
                <div class="card h-100 shadow-sm border-primary">
                    <div class="card-body">
                        <h5 class="card-title mb-3 d-flex align-items-center gap-2 justify-content-center">
                            <i class="bi bi-info-circle"></i> Información rápida
                        </h5>
                        <div class="info-list text-start mx-auto" style="max-width: 320px;">
                            {% if componente %}
                            <div class="info-item d-flex justify-content-between py-1 border-bottom">
                                <span class="info-label fw-semibold">ID</span>
                                <span class="info-value text-muted">{{ componente.ID }}</span>
                            </div>
                            {% if componente.ID_Componente %}
                            <div class="info-item d-flex justify-content-between py-1 border-bottom">
                                <span class="info-label fw-semibold">Código</span>
                                <span class="info-value text-muted">{{ componente.ID_Componente }}</span>
                            </div>
                            {% endif %}
                            {% endif %}
                            <div class="info-item d-flex justify-content-between py-1">
                                <span class="info-label fw-semibold">Estado</span>
                                <span class="info-value">
                                    <span class="badge bg-agri-primary">En edición</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

// Evento para subir la foto
document.getElementById('foto').addEventListener('change', function (e) {
    const fileInput = e.target;
    const fileName = fileInput.files[0] ? fileInput.files[0].name : "No se ha seleccionado ningún archivo.";
    document.getElementById('file-name').textContent = "Imagen seleccionada: " + fileName;

    // Vista previa de la imagen
    const preview = document.getElementById('image-preview');
    preview.innerHTML = ''; // Limpiar cualquier imagen previa

    if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'img-thumbnail';
            img.style.maxWidth = '200px';
            preview.appendChild(img);
        }
        reader.readAsDataURL(fileInput.files[0]);
    }
});

function showFileName(input) {
    const fileName = input.files.length > 0 ? input.files[0].name : 'No se ha seleccionado ningún archivo.';
    document.getElementById('file-name').textContent = fileName;
}

function confirmDelete() {
    const form = document.getElementById('deleteForm');
    if (form && confirm("¿Estás seguro de que querés eliminar este componente? Esta acción no se puede deshacer.")) {
        form.submit();
    } else {
        console.error("Formulario de eliminación no encontrado.");
    }
}

document.getElementById('clearImage')?.addEventListener('click', () => {
    const fileInput = document.getElementById('foto');
    const fileName = document.getElementById('file-name');
    const preview = document.getElementById('image-preview');

    fileInput.value = '';
    fileName.textContent = "No se ha seleccionado ningún archivo.";
    preview.innerHTML = '';
});

// Animación de cartas
document.addEventListener('DOMContentLoaded', function () {
    const detailCard = document.querySelector('.card.detail-card');
    if (detailCard) {
        detailCard.classList.add('show');
        // Agregar .show a cartas embebidas
        detailCard.querySelectorAll('.card:not(.detail-card)').forEach(card => {
            card.classList.add('show');
        });
    }
});

</script>

<style>

.btn-agri-primary {
    display: flex;
    align-items: center;
    justify-content: center;
}
.badge.bg-agri-primary {
    background-color: var(--agri-green-primary);
    color: #fff;
    font-weight: 700;
}
.card.detail-card .card {
    border: none;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.5s cubic-bezier(.4,2,.6,1);
}
.card.detail-card .card.show {
    opacity: 1;
    transform: translateY(0);
}
.form-control {
    width: 100% !important;
}
.col-md-6 {
    flex: 0 0 100% !important;
}

</style>

{% endblock %}
