{% extends "base.html" %}

{% block content %}
<div class="page-wrapper">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div class="flex-grow-1">
                <h2 class="section-title"><i class="bi bi-pencil-square"></i> Editar Máquina</h2>
                <p class="section-subtitle d-none d-md-block opacity-75">Modifica la información de la máquina</p>
            </div>
            <div class="d-flex align-items-center gap-2 flex-wrap ms-auto">
                <a href="{{ url_for('maquinas.listar_maquinas') }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-arrow-left"></i> 
                    <span class="d-none d-md-inline">Volver a Máquinas</span>
                    <span class="d-md-none">Volver</span>
                </a>
                {% if maquina %}
                <a href="{{ url_for('maquinas.ver_maquina', id=maquina.ID) }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-eye"></i> 
                    <span class="d-none d-md-inline">Ver Máquina</span>
                    <span class="d-md-none">Ver</span>
                </a>
                {% endif %}
                <div class="badge fs-6 d-none d-lg-block">
                    <i class="bi bi-calendar3"></i> <span id="current-date"></span>
                </div>
                <button class="theme-toggle" id="themeToggle">
                    <i class="bi bi-moon-fill" id="themeIcon"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Formulario -->
    <div class="card-section mb-4 mx-auto" style="max-width: 700px;">
        <h3 class="section-title mb-0 d-flex align-items-center gap-2 justify-content-center">
            <i class="bi bi-info-circle"></i> Información
        </h3>
        <form method="POST" enctype="multipart/form-data" id="editMachineForm" 
            class="form-edit row g-3">
            <!-- Nombre -->
            <div class="col-12 col-md-6">
                <label for="nombre" class="form-label required">
                    <i class="bi bi-tag"></i> Nombre
                </label>
                <input type="text" class="form-control" id="nombre" name="nombre"
                    value="{{ maquina.Nombre if maquina and maquina.Nombre is not none else '' }}"
                    required placeholder="Ej: Tractor John Deere">
            </div>
            <!-- Marca -->
            <div class="col-12 col-md-6">
                <label for="marca" class="form-label">
                    <i class="bi bi-award"></i> Marca
                </label>
                <input type="text" class="form-control" id="marca" name="marca"
                    value="{{ maquina.Marca if maquina and maquina.Marca is not none else '' }}"
                    placeholder="Ej: John Deere">
            </div>
            <!-- Modelo -->
            <div class="col-12 col-md-6">
                <label for="modelo" class="form-label">
                    <i class="bi bi-gear"></i> Modelo
                </label>
                <input type="text" class="form-control" id="modelo" name="modelo"
                    value="{{ maquina.Modelo if maquina and maquina.Modelo is not none else '' }}"
                    placeholder="Ej: 5050E">
            </div>
            <!-- Año -->
            <div class="col-12 col-md-6">
                <label for="anio" class="form-label">
                    <i class="bi bi-calendar"></i> Año
                </label>
                <input type="number" class="form-control" id="anio" name="anio"
                    value="{{ maquina.Año if maquina and maquina.Año is not none else '' }}"
                    placeholder="Ej: 2020">
            </div>
            <!-- Tipo -->
            <div class="col-12 col-md-6">
                <label for="tipo" class="form-label">
                    <i class="bi bi-collection"></i> Estado
                </label>
                <select class="form-select" id="tipo" name="tipo">
                    <option value="">Seleccionar estado...</option>
                    {% set tipo_actual = maquina.Estado if maquina and maquina.Estado is not none else '' %}
                    <option value="Operativa" {{ 'selected' if tipo_actual == 'Operativa' else '' }}>Operativa</option>
                    <option value="En Taller" {{ 'selected' if tipo_actual == 'En Taller' else '' }}>En Taller</option>
                    <option value="Reserva" {{ 'selected' if tipo_actual == 'Reserva' else '' }}>Reserva</option>
                    <option value="Fuera de servicio" {{ 'selected' if tipo_actual == 'Fuera de servicio' else '' }}>Fuera de servicio</option>
                </select>
            </div>
            <!-- Observaciones -->
            <div class="col-12">
                <label for="observaciones" class="form-label">
                    <i class="bi bi-card-text"></i> Observaciones
                </label>
                <textarea class="form-control" id="observaciones" name="observaciones"
                    rows="3"
                    placeholder="Observaciones, detalles de mantenimiento, etc.">{{ maquina.Observaciones if maquina and maquina.Observaciones is not none else '' }}</textarea>
            </div>
            <!-- Imagen -->
            <div class="col-12">
                <label for="foto" class="form-label">
                    <i class="bi bi-image"></i> Imagen
                </label>
                <input type="file" class="form-control" id="foto" name="foto" accept="image/*">
                <div class="form-text">
                    Formatos soportados: JPG, PNG, GIF. Tamaño máximo: 5MB
                    {% if maquina and maquina.Foto %}
                        <br><small class="text-muted">Imagen actual: {{ maquina.Foto }}</small>
                    {% endif %}
                </div>
            </div>
            <!-- Botones de acción -->
            <div class="d-flex gap-3 mt-4 pt-3 border-top justify-content-between align-items-center flex-wrap">
                <button type="submit" class="btn btn-agri-primary" style="border: transparent;">
                    <i class="bi bi-check-lg"></i> Guardar
                </button>
                <a href="{{ url_for('maquinas.listar_maquinas') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg"></i> Cancelar
                </a>
                {% if maquina %}
                <button type="button" class="btn btn-outline-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Carta con cartas embebidas -->
    <div class="card detail-card p-4 shadow-sm mx-auto" style="max-width: 700px;">
        <h4 class="card-title mb-0 d-flex align-items-center gap-2 justify-content-center">
            <i class="bi bi-box-seam"></i> Detalles
        </h4>

        <div class="row g-4 mt-0">
            <!-- Vista Previa -->
            <div class="col-12 col-md-6 mx-auto" style="max-width: 100%;">
                <div class="card h-100 shadow-sm border-secondary">
                    <div class="card-body text-center">
                        <h5 class="card-title mb-3 d-flex align-items-center justify-content-center gap-2">
                            <i class="bi bi-image"></i> Vista Previa
                        </h5>
                        {% if componente and componente.Foto %}
                            <img src="{{ url_for('static', filename='fotos/componentes/' ~ componente.Foto) }}"
                                alt="Vista previa"
                                class="img-fluid rounded shadow mx-auto d-block"
                                style="max-height: 220px; object-fit: contain;">
                        {% else %}
                            <div class="image-placeholder mx-auto" 
                                style="width: 180px; height: 180px;">
                                <i class="bi bi-image fs-1"></i>
                                <p class="mb-0 mt-2">Sin imagen</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Información rápida -->
            <div class="col-12 col-md-6 mx-auto" style="max-width: 100%;">
                <div class="card h-100 shadow-sm border-primary">
                    <div class="card-body">
                        <h5 class="card-title mb-3 d-flex align-items-center gap-2 justify-content-center">
                            <i class="bi bi-info-circle"></i> Información rápida
                        </h5>
                        <div class="info-list text-start mx-auto" style="max-width: 320px;">
                            {% if componente %}
                            <div class="info-item d-flex justify-content-between py-1 border-bottom">
                                <span class="info-label fw-semibold">ID</span>
                                <span class="info-value text-muted">{{ componente.ID }}</span>
                            </div>
                            {% if componente.ID_Componente %}
                            <div class="info-item d-flex justify-content-between py-1 border-bottom">
                                <span class="info-label fw-semibold">Código</span>
                                <span class="info-value text-muted">{{ componente.ID_Componente }}</span>
                            </div>
                            {% endif %}
                            {% endif %}
                            <div class="info-item d-flex justify-content-between py-1">
                                <span class="info-label fw-semibold">Estado</span>
                                <span class="info-value">
                                    <span class="badge bg-agri-primary">En edición</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const detailCard = document.querySelector('.card.detail-card');
    if (detailCard) {
        detailCard.classList.add('show');
        // Agregar .show a cartas embebidas
        detailCard.querySelectorAll('.card:not(.detail-card)').forEach(card => {
            card.classList.add('show');
        });
    }
});
</script>
<style>
.btn-agri-primary {
    display: flex;
    align-items: center;
    justify-content: center;
}

.badge.bg-agri-primary {
    background-color: var(--agri-green-primary);
    color: #fff;
    font-weight: 700;
}

.card.detail-card .card {
    border: none;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.5s cubic-bezier(.4,2,.6,1);
}

.card.detail-card .card.show {
    opacity: 1;
    transform: translateY(0);
}
</style>
{% endblock %}