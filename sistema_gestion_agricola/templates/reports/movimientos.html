<!-- templates/reports/movimientos.html - Reporte de Movimientos -->
{% extends "base.html" %} {% block title %}Reporte de Movimientos - Sistema de
Gesti칩n Agr칤cola{% endblock %} {% block extra_css %}
<style>
  .stats-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
    height: 100%;
  }

  .stats-card:hover {
    transform: translateY(-2px);
  }

  .stats-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
  }

  .movement-in {
    border-left: 4px solid #28a745;
  }

  .movement-out {
    border-left: 4px solid #dc3545;
  }

  .chart-container {
    position: relative;
    height: 400px;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>游늳 Reporte de Movimientos</h2>
      <p class="text-muted">An치lisis de entradas y salidas de stock</p>
      <small class="text-muted"
        >Per칤odo: {{ fecha_desde }} - {{ fecha_hasta }}</small
      >
    </div>
    <div class="btn-group">
      <a
        href="{{ url_for('reports.movimientos_report', format='csv', desde=fecha_desde, hasta=fecha_hasta) }}"
        class="btn btn-outline-success"
      >
        <i class="fas fa-download"></i> Exportar CSV
      </a>
      <a
        href="{{ url_for('reports.movimientos_report', format='json', desde=fecha_desde, hasta=fecha_hasta) }}"
        class="btn btn-outline-info"
      >
        <i class="fas fa-code"></i> API JSON
      </a>
    </div>
  </div>

  <!-- Estad칤sticas Generales -->
  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="card stats-card text-center">
        <div class="card-body">
          <div class="stats-icon text-primary">游늵</div>
          <h3 class="card-title">{{ estadisticas.total_movimientos }}</h3>
          <p class="card-text text-muted">Total Movimientos</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card stats-card text-center">
        <div class="card-body">
          <div class="stats-icon text-success">游닌</div>
          <h3 class="card-title">{{ estadisticas.total_entradas }}</h3>
          <p class="card-text text-muted">Total Entradas</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card stats-card text-center">
        <div class="card-body">
          <div class="stats-icon text-danger">游닋</div>
          <h3 class="card-title">{{ estadisticas.total_salidas }}</h3>
          <p class="card-text text-muted">Total Salidas</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card stats-card text-center">
        <div class="card-body">
          <div
            class="stats-icon {% if estadisticas.saldo_neto >= 0 %}text-success{% else %}text-danger{% endif %}"
          >
            丘뒲잺
          </div>
          <h3 class="card-title">{{ estadisticas.saldo_neto }}</h3>
          <p class="card-text text-muted">Saldo Neto</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Gr치fico de Tendencias -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5>游늵 Tendencia de Movimientos</h5>
        </div>
        <div class="card-body">
          <div id="chart-movimientos" class="chart-container">
            <div class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando gr치fico...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5>游늶 Resumen Diario</h5>
        </div>
        <div class="card-body" style="max-height: 400px; overflow-y: auto">
          {% for fecha, datos in movimientos_por_dia.items() %}
          <div
            class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded"
          >
            <small class="fw-bold">{{ fecha }}</small>
            <div>
              <span class="badge bg-success me-1">+{{ datos.entradas }}</span>
              <span class="badge bg-danger">-{{ datos.salidas }}</span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-header">
      <h5>游댌 Filtros de B칰squeda</h5>
    </div>
    <div class="card-body">
      <form method="GET" action="{{ url_for('reports.movimientos_report') }}">
        <div class="row">
          <div class="col-md-3">
            <label for="desde" class="form-label">Fecha Desde</label>
            <input
              type="date"
              name="desde"
              id="desde"
              class="form-control"
              value="{{ fecha_desde }}"
            />
          </div>
          <div class="col-md-3">
            <label for="hasta" class="form-label">Fecha Hasta</label>
            <input
              type="date"
              name="hasta"
              id="hasta"
              class="form-control"
              value="{{ fecha_hasta }}"
            />
          </div>
          <div class="col-md-3">
            <label for="tipo" class="form-label">Tipo de Movimiento</label>
            <select name="tipo" id="tipo" class="form-select">
              <option value="all">Todos los movimientos</option>
              <option value="entrada">Solo Entradas</option>
              <option value="salida">Solo Salidas</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <div>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i> Filtrar
              </button>
              <a
                href="{{ url_for('reports.movimientos_report') }}"
                class="btn btn-outline-secondary"
              >
                <i class="fas fa-times"></i> Limpiar
              </a>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabla de Movimientos -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5>游늶 Movimientos Detallados</h5>
      <small class="text-muted"
        >Generado: {{ fecha_generacion.strftime('%d/%m/%Y %H:%M') }}</small
      >
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover" id="movements-table">
          <thead class="table-dark">
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Componente</th>
              <th class="text-center">Cantidad</th>
              <th>Observaci칩n</th>
            </tr>
          </thead>
          <tbody>
            {% for mov in movimientos %}
            <tr
              class="{% if mov.Tipo == 'entrada' %}movement-in{% else %}movement-out{% endif %}"
            >
              <td>
                <small>{{ mov.Fecha.strftime('%d/%m/%Y') }}</small><br />
                <small class="text-muted"
                  >{{ mov.Fecha.strftime('%H:%M') }}</small
                >
              </td>
              <td>
                {% if mov.Tipo == 'entrada' %}
                <span class="badge bg-success">
                  <i class="fas fa-arrow-up"></i> Entrada
                </span>
                {% else %}
                <span class="badge bg-danger">
                  <i class="fas fa-arrow-down"></i> Salida
                </span>
                {% endif %}
              </td>
              <td>
                <strong>{{ mov.componente_nombre }}</strong>
              </td>
              <td class="text-center">
                <span
                  class="badge {% if mov.Tipo == 'entrada' %}bg-success{% else %}bg-danger{% endif %}"
                >
                  {% if mov.Tipo == 'entrada' %}+{% else %}-{% endif %}{{
                  mov.Cantidad }}
                </span>
              </td>
              <td>
                {% if mov.Observacion %} {{ mov.Observacion }} {% else %}
                <span class="text-muted">Sin observaci칩n</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
  $(document).ready(function () {
    // Inicializar DataTable
    $("#movements-table").DataTable({
      pageLength: 25,
      order: [[0, "desc"]], // Ordenar por fecha descendente
      language: {
        url: "//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json",
      },
    });

    // Cargar gr치fico de movimientos
    loadMovementsChart();
  });

  function loadMovementsChart() {
    fetch("/reports/chart/movimientos_tiempo")
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success") {
          document.getElementById(
            "chart-movimientos"
          ).innerHTML = `<img src="${data.image}" class="img-fluid" alt="Gr치fico de movimientos en el tiempo">`;
        } else {
          document.getElementById("chart-movimientos").innerHTML =
            '<div class="alert alert-danger">Error al cargar el gr치fico</div>';
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        document.getElementById("chart-movimientos").innerHTML =
          '<div class="alert alert-danger">Error al cargar el gr치fico</div>';
      });
  }
</script>
{% endblock %}
